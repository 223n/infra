- name:
  hosts: all
  become: yes
  pre_tasks:
    - name: update cache and cleanup package
      apt:
        update_cache: yes
        autoremove: yes
  roles:
    - dev-sec.os-hardening
    - dev-sec.ssh-hardening
    - common
    - mackerel-agent
    - lexicon
    - dehydrated
    - nginx
  tasks:
    - name: clound-init hostname setting
      block:
        - name: check clound-init config
          stat:
            path: /etc/cloud/cloud.cfg
          register: result
        - name: remove clound-init hostname reset setting
          lineinfile:
            path: /etc/cloud/cloud.cfg
            regexp: "^manage_etc_hosts: (yes|on|true)"
            state: absent
          when: result.stat.exists
      tags:
        - hostname
